{% extends "_layout_compras.html" %}
{% block Title %} Inicio Compras {% endblock %}
{% block css %}
<style>
    .text-muted {
        color: #000000 !important;
    }
</style>
{% endblock css %}
{% block content %}
{% load static %}
<div class="container py-4">
    <div class="title-bar px-2 px-md-4">
        <h2 class="fw-bold text-danger text-center"><i class="bi bi-graph-up"></i> Panel de Indicadores</h2>
        <p class="text-muted text-center">Visualiza la gesti√≥n de proveedores, solicitudes y propuestas en tiempo real.</p>
    </div>
</div>

    <!-- M√âTRICAS PRINCIPALES -->

    <div class="row text-center mb-4 g-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Total Proveedores</h6>
                    <h3 class="fw-bold text-danger" id="valorProveedores">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Total Solicitudes </h6>
                    <h3 class="fw-bold text-danger" id="valorSolicitudes">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Total De Propuestas</h6>
                    <h3 class="fw-bold text-danger" id="valorPropuestas">-</h3>
                </div>
            </div>
        </div>
    </div>
    <!-- GR√ÅFICOS / LISTAS -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Distribuci√≥n de Proveedores</h6>
                    <canvas id="graficoProveedores" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <!-- Lista de Solicitudes -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Solicitudes Recientes</h6>
                    <ul class="list-group list-group-flush">
                        {% for solicitud in solicitudes_recientes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ solicitud.identificador }}
                            <span class="badge 
                        {% if solicitud.estado == 'Nueva' or solicitud.estado == 'Abierta' %}
                            bg-primary
                        {% elif solicitud.estado == 'En revisi√≥n' %}
                            bg-warning text-dark
                        {% elif solicitud.estado == 'Cerrada' %}
                            bg-success
                        {% else %}
                            bg-secondary
                        {% endif %}">
                                {{ solicitud.estado }}
                            </span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No hay solicitudes recientes</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Propuestas y Acciones -->
    <div class="row mt-4 g-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Distribuci√≥n de Propuestas</h6>
                    <canvas id="graficoPropuestas" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-success text-white d-flex align-items-center">
                    <i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>
                    <h6 class="mb-0">Solicitudes que requieren atenci√≥n</h6>
                </div>
                <div class="card-body">
                    <p class="fw-bold fs-5 mb-4">¬øQu√© deseas hacer?</p>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <a href="{%url 'compras:missolicitudes'%}" class="btn btn-outline-success w-100">
                                ‚úÖ Aprobar propuesta
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'compras:tareas' %}" class="btn btn-outline-primary w-100">
                                üåü Asignar tarea
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{%url 'compras:misproveedores'%}" class="btn btn-outline-warning w-100">
                                üìä Evaluar proveedor
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'compras:missolicitudes' %}" class="btn btn-outline-info w-100">
                                üìç Nueva solicitud
                            </a>
                        </div>
                        <div class="col-12">
                            <a href="{% url 'compras:missolicitudes' %}" class="btn btn-outline-secondary w-100">
                                ‚úâÔ∏è Responder comentarios
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block grafico %}
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch('/compras/dashboard/data/')
            .then(res => res.json())
            .then(data => {

                const totalProveedores = data.proveedores.reduce((a, b) => a + b, 0);
                const totalSolicitudes = data.solicitudes.reduce((a, b) => a + b, 0);
                const totalPropuestas = data.propuestas.reduce((a, b) => a + b, 0);

                document.getElementById('valorProveedores').innerText = totalProveedores.toLocaleString();
                document.getElementById('valorSolicitudes').innerText = totalSolicitudes.toLocaleString();
                document.getElementById('valorPropuestas').innerText = totalPropuestas.toLocaleString();
                // ===== GR√ÅFICO DE PROVEEDORES =====
                if (totalProveedores > 0) {
                    new Chart(document.getElementById('graficoProveedores'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Activos', 'Inactivos'],
                            datasets: [{
                                data: data.proveedores,
                                backgroundColor: ['#21F339', '#F32132']
                            }]
                        },
                        options: {
                            cutout: '70%',
                            responsive: true
                        }
                    });
                }
                // ===== GR√ÅFICO DE PROPUESTAS =====
                if (totalPropuestas > 0) {
                    new Chart(document.getElementById('graficoPropuestas'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Aceptadas', 'Rechazadas', 'Enviadas'],
                            datasets: [{
                                data: data.propuestas,
                                backgroundColor: ['#21F339', '#F32132', '#FFB700']
                            }]
                        },
                        options: {
                            cutout: '70%',
                            responsive: true
                        }
                    });
                }
            })
            .catch(err => {
                console.error("Error al cargar datos del dashboard:", err);
            });
    });
</script>
{% endblock %}