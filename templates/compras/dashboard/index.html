{% extends "_layout_compras.html" %}
{% block Title %} Inicio Compras {% endblock %}

{% block content %}
{% load static %}
<div class="container mt-4">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-graph-up"></i> Panel de Indicadores</h2>
        <p class="text-muted">Visualiza la gestión de proveedores, solicitudes y propuestas en tiempo real.</p>
    </div>

    <!-- MÉTRICAS PRINCIPALES -->
    <div class="row text-center mb-4 g-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Proveedores Activos</h6>
                    <h3 class="fw-bold text-primary" id="valorProveedores">-</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Solicitudes Abiertas</h6>
                    <h3 class="fw-bold text-success" id="valorSolicitudes">-</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-muted">Propuestas Pendientes</h6>
                    <h3 class="fw-bold text-danger" id="valorPropuestas">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Distribución de Proveedores</h6>
                    <canvas id="graficoProveedores" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Distribución de Solicitudes</h6>
                    <canvas id="graficoSolicitudes" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Distribución de Propuestas</h6>
                    <canvas id="graficoPropuestas" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Solicitudes que requieren atención</h6>
                    <p class="fw-bold fs-4">0.43</p>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">🔔 Acciones requeridas</li>
                        <li class="list-group-item">📄 Acciones en curso</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block grafico %}
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch('/compras/dashboard/data/')
    .then(res => res.json())
    .then(data => {
        // ===== MÉTRICAS PRINCIPALES =====
        const totalProveedores = data.proveedores.reduce((a,b) => a + b, 0);
        const totalSolicitudes = data.solicitudes.reduce((a,b) => a + b, 0);
        const totalPropuestas = data.propuestas.reduce((a,b) => a + b, 0);

        document.getElementById('valorProveedores').innerText = totalProveedores.toLocaleString();
        document.getElementById('valorSolicitudes').innerText = totalSolicitudes.toLocaleString();
        document.getElementById('valorPropuestas').innerText = totalPropuestas.toLocaleString();

        // ===== GRÁFICO DE PROVEEDORES =====
        if (totalProveedores > 0) {
            new Chart(document.getElementById('graficoProveedores'), {
                type: 'doughnut',
                data: {
                    labels: ['Activos', 'Inactivos'],
                    datasets: [{
                        data: data.proveedores,
                        backgroundColor: ['#2196f3', '#009688']
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true
                }
            });
        }

        // ===== GRÁFICO DE SOLICITUDES =====
        if (totalSolicitudes > 0) {
            new Chart(document.getElementById('graficoSolicitudes'), {
                type: 'doughnut',
                data: {
                    labels: ['Abiertas', 'En revisión', 'Cerradas'],
                    datasets: [{
                        data: data.solicitudes,
                        backgroundColor: ['#ffc107', '#03a9f4', '#8e24aa']
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true
                }
            });
        }

        // ===== GRÁFICO DE PROPUESTAS =====
        if (totalPropuestas > 0) {
            new Chart(document.getElementById('graficoPropuestas'), {
                type: 'doughnut',
                data: {
                    labels: ['Aceptadas', 'Rechazadas', 'Enviadas'],
                    datasets: [{
                        data: data.propuestas,
                        backgroundColor: ['#00bcd4', '#e91e63', '#cddc39']
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true
                }
            });
        }
    })
    .catch(err => {
        console.error("Error al cargar datos del dashboard:", err);
    });
});
</script>
{% endblock %}
